# This workflow will :
# - create minified versions of createstubs*.py
# - run tests on these
# - and submit a PR to the branch <branch>-minify

name: minify-all

on:
  workflow_dispatch:
  push:
    paths:
      - "board/**"

jobs:
  minify:
    runs-on: ubuntu-20.04 # ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Extract branch name (for potential PR)
        id: extract_branch
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"

      - name: Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: 3.9

      #----------------------------------------------
      # poetry is not in the default image
      #----------------------------------------------
      - name: Install Poetry
        run: pipx install poetry==1.3.1

      #----------------------------------------------
      # install root project
      #----------------------------------------------
      - name: Install library
        run: poetry install --with dev --no-interaction

      - name: flag tools executable
        if: runner.os == 'Linux'
        run: |
          chmod +x $GITHUB_WORKSPACE/tests/tools/* --recursive --verbose
          MICROPYPATH=./tests/mocks/libs ./tests/tools/ubuntu_20_04/micropython_v1_18 -c "import sys;print(sys.path);import logging"

      - name: make all variants
        run: |
          poetry run stubber make-variants

      - name: run test on minified/createstubs.by
        run: |
          poetry run pytest -m minified

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v4
        # ref: https://github.com/peter-evans/create-pull-request
        with:
          title: "${{ steps.extract_branch.outputs.branch }} : update minified/createstubs.py"
          commit-message: add/update minified
          branch: ${{ steps.extract_branch.outputs.branch }}-minify
          labels: |
            automated pr

      - name: Check outputs
        if: always()
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
